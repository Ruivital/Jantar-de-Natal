<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agenda Familiar</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
    body.light { background: #fafafa; color: #1e1e1e; }
    body.dark { background: #1e1e1e; color: #f5f5f5; }
    .header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
    .calendar { display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 5px; margin-top: 20px; }
    .day { border: 1px solid #888; padding: 15px; text-align: center; cursor: pointer; border-radius: 8px; font-size: 1rem; }
    .day.today { background: #005a9c; color: #fff; font-weight: bold; }
    .day.selected { background: #0078d4; color: #fff; }
    .day.holiday.light { background: #2e7d32; color: #fff; font-weight: bold; }
    .day.holiday.dark { background: #ffd600; color: #000; font-weight: bold; }
    .items-container { margin-top: 20px; border: 1px solid #666; border-radius: 8px; padding: 10px; max-height: 300px; overflow-y: auto; }
    input, select, button { padding: 8px; font-size: 1rem; border-radius: 4px; margin: 5px; }
  </style>
</head>
<body class="light">
  <div class="header">
    <div>
      <button id="prevMonth">&lt;</button>
      <span id="monthYear"></span>
      <button id="nextMonth">&gt;</button>
    </div>
    <div>
      <select id="userSelect"></select>
      <button id="toggleTheme">Tema</button>
      <button id="todayBtn">Hoje</button>
    </div>
  </div>

  <div class="calendar" id="calendar"></div>

  <div>
    <h3 id="selectedDate"></h3>
    <input type="text" id="itemText" placeholder="Novo compromisso...">
    <button id="addBtn">Criar</button>
    <div class="items-container">
      <ul id="itemsList"></ul>
    </div>
  </div>

<script>
const users = ["Rui","Sandra","Sónia"];
let currentUser = users[0];
let theme = 'light';
let today = new Date();
let currentDate = new Date(today.getFullYear(), today.getMonth(), 1);
let selectedDate = new Date(today);
let items = [];
let editItemId = null;

const userSelect = document.getElementById('userSelect');
users.forEach(u => {
  let opt = document.createElement('option');
  opt.value = u; opt.textContent = u;
  userSelect.appendChild(opt);
});
userSelect.addEventListener('change', () => currentUser = userSelect.value);

document.getElementById('toggleTheme').onclick = () => {
  theme = theme==='light'?'dark':'light';
  document.body.className = theme;
  renderCalendar();
};
document.getElementById('todayBtn').onclick = () => { today=new Date(); currentDate=new Date(today.getFullYear(),today.getMonth(),1); selectedDate=new Date(today); renderCalendar(); renderItems(); };
document.getElementById('prevMonth').onclick = () => { currentDate=new Date(currentDate.getFullYear(),currentDate.getMonth()-1,1); renderCalendar(); };
document.getElementById('nextMonth').onclick = () => { currentDate=new Date(currentDate.getFullYear(),currentDate.getMonth()+1,1); renderCalendar(); };
document.getElementById('addBtn').onclick = addItem;

async function loadItems(){
  let res = await fetch("save.php?action=load");
  items = await res.json();
  renderCalendar(); renderItems();
}
async function saveItems(){
  await fetch("save.php?action=save",{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(items)
  });
}

function addItem(){
  if(!document.getElementById('itemText').value.trim()) return;
  if(editItemId){
    items = items.map(i => i.id===editItemId?{...i,title:document.getElementById('itemText').value,date:selectedDate.toDateString(),creator:currentUser}:i);
    editItemId=null;
  }else{
    items.push({id:Date.now(),title:document.getElementById('itemText').value,date:selectedDate.toDateString(),creator:currentUser});
  }
  document.getElementById('itemText').value="";
  saveItems(); renderItems();
}

function editItem(item){
  if(item.creator!==currentUser) return;
  document.getElementById('itemText').value=item.title;
  editItemId=item.id;
}
function deleteItem(item){
  if(item.creator!==currentUser) return;
  items=items.filter(i=>i.id!==item.id);
  saveItems(); renderItems();
}

// ======= FERIADOS =======
function calcularPascoa(ano) {
  let a = ano % 19;
  let b = Math.floor(ano / 100);
  let c = ano % 100;
  let d = Math.floor(b / 4);
  let e = b % 4;
  let f = Math.floor((b + 8) / 25);
  let g = Math.floor((b - f + 1) / 3);
  let h = (19 * a + b - d - g + 15) % 30;
  let i = Math.floor(c / 4);
  let k = c % 4;
  let l = (32 + 2 * e + 2 * i - h - k) % 7;
  let m = Math.floor((a + 11 * h + 22 * l) / 451);
  let mes = Math.floor((h + l - 7 * m + 114) / 31) - 1;
  let dia = ((h + l - 7 * m + 114) % 31) + 1;
  return new Date(ano, mes, dia);
}

function getFeriados(ano) {
  const pascoa = calcularPascoa(ano);
  const feriados = [
    { dia: 1, mes: 0, nome: "Ano Novo" },
    { dia: 25, mes: 3, nome: "25 de Abril" },
    { dia: 1, mes: 4, nome: "Dia do Trabalhador" },
    { dia: 10, mes: 5, nome: "Dia de Portugal" },
    { dia: 15, mes: 7, nome: "Assunção de Maria" },
    { dia: 5, mes: 9, nome: "Implantação da República" },
    { dia: 1, mes: 10, nome: "Todos os Santos" },
    { dia: 1, mes: 11, nome: "Restauração da Independência" },
    { dia: 8, mes: 11, nome: "Imaculada Conceição" },
    { dia: 25, mes: 11, nome: "Natal" },
    { dia: 22, mes: 4, nome: "Feriado de Leiria" }
  ];
  // Feriados móveis
  let sextaSanta = new Date(pascoa); sextaSanta.setDate(pascoa.getDate() - 2);
  let corpoDeus = new Date(pascoa); corpoDeus.setDate(pascoa.getDate() + 60);
  let marinhaGrande = new Date(pascoa); marinhaGrande.setDate(pascoa.getDate() + 40);

  feriados.push({ dia: pascoa.getDate(), mes: pascoa.getMonth(), nome: "Páscoa" });
  feriados.push({ dia: sextaSanta.getDate(), mes: sextaSanta.getMonth(), nome: "Sexta-feira Santa" });
  feriados.push({ dia: corpoDeus.getDate(), mes: corpoDeus.getMonth(), nome: "Corpo de Deus" });
  feriados.push({ dia: marinhaGrande.getDate(), mes: marinhaGrande.getMonth(), nome: "Marinha Grande" });

  return feriados;
}

function isFeriado(data){
  const lista = getFeriados(data.getFullYear());
  return lista.some(f => f.dia===data.getDate() && f.mes===data.getMonth());
}

// ======= RENDER =======
function renderCalendar(){
  const monthNames=["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
  document.getElementById('monthYear').textContent=monthNames[currentDate.getMonth()]+" "+currentDate.getFullYear();
  const calendar=document.getElementById('calendar');
  calendar.innerHTML="";
  const daysInMonth=new Date(currentDate.getFullYear(),currentDate.getMonth()+1,0).getDate();
  for(let d=1;d<=daysInMonth;d++){
    const thisDate=new Date(currentDate.getFullYear(),currentDate.getMonth(),d);
    let day=document.createElement('div'); day.className="day"; day.textContent=d;
    if(thisDate.toDateString()===today.toDateString()) day.classList.add("today");
    if(thisDate.toDateString()===selectedDate.toDateString()) day.classList.add("selected");
    if(isFeriado(thisDate)) day.classList.add("holiday", theme);
    day.onclick=()=>{selectedDate=thisDate; renderCalendar(); renderItems();};
    calendar.appendChild(day);
  }
}

function renderItems(){
  document.getElementById('selectedDate').textContent=selectedDate.toDateString();
  const ul=document.getElementById('itemsList'); ul.innerHTML="";
  items.filter(i=>i.date===selectedDate.toDateString()).forEach(i=>{
    let li=document.createElement('li');
    li.textContent=i.title+" ("+i.creator+") ";
    if(i.creator===currentUser){
      let e=document.createElement('button'); e.textContent="Editar"; e.onclick=()=>editItem(i);
      let d=document.createElement('button'); d.textContent="Apagar"; d.onclick=()=>deleteItem(i);
      li.appendChild(e); li.appendChild(d);
    }
    ul.appendChild(li);
  });
}

loadItems();
</script>
</body>
</html>


